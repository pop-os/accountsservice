From: Frederic Peters <fpeters@debian.org>
Date: Sat, 12 Oct 2019 10:29:08 +0200
Subject: Create and manage groups like on a debian system.

Bug-Debian: http://bugs.debian.org/618764
Forwarded: not-needed

Description: Create and manage groups like on a debian system.
---
 src/daemon.c | 29 ++++++++++-------------------
 src/util.c   | 42 ++++++++++++++++++++++++++++++++++++++++++
 src/util.h   |  8 ++++++++
 3 files changed, 60 insertions(+), 19 deletions(-)

diff --git a/src/daemon.c b/src/daemon.c
index c52bda3..43aa45c 100644
--- a/src/daemon.c
+++ b/src/daemon.c
@@ -1106,25 +1106,12 @@ daemon_create_user_authorized_cb (Daemon                *daemon,
 
         sys_log (context, "create user '%s'", cd->user_name);
 
-        argv[0] = "/usr/sbin/useradd";
-        argv[1] = "-m";
-        argv[2] = "-c";
-        argv[3] = cd->real_name;
-        if (cd->account_type == ACCOUNT_TYPE_ADMINISTRATOR) {
-                if (EXTRA_ADMIN_GROUPS != NULL && EXTRA_ADMIN_GROUPS[0] != '\0')
-                        admin_groups = g_strconcat (ADMIN_GROUP, ",",
-                                                    EXTRA_ADMIN_GROUPS, NULL);
-                else
-                        admin_groups = g_strdup (ADMIN_GROUP);
-
-                argv[4] = "-G";
-                argv[5] = admin_groups;
-                argv[6] = "--";
-                argv[7] = cd->user_name;
-                argv[8] = NULL;
-        }
-        else if (cd->account_type == ACCOUNT_TYPE_STANDARD) {
-                argv[4] = "--";
+        if (cd->account_type == ACCOUNT_TYPE_ADMINISTRATOR || cd->account_type == ACCOUNT_TYPE_STANDARD) {
+                argv[0] = "/usr/sbin/adduser";
+                argv[1] = "--quiet";
+                argv[2] = "--disabled-login";
+                argv[3] = "--gecos";
+                argv[4] = cd->real_name;
                 argv[5] = cd->user_name;
                 argv[6] = NULL;
         }
@@ -1138,6 +1125,10 @@ daemon_create_user_authorized_cb (Daemon                *daemon,
                 return;
         }
 
+        if (cd->account_type == ACCOUNT_TYPE_ADMINISTRATOR) {
+                add_user_to_group (context, cd->user_name, ADMIN_GROUP);
+        }
+
         user = daemon_local_find_user_by_name (daemon, cd->user_name);
         user_update_local_account_property (user, TRUE);
         user_update_system_account_property (user, FALSE);
diff --git a/src/util.c b/src/util.c
index 0372b4b..a014e6f 100644
--- a/src/util.c
+++ b/src/util.c
@@ -289,3 +289,45 @@ get_caller_uid (GDBusMethodInvocation *context,
 
         return TRUE;
 }
+
+void
+add_user_to_group (GDBusMethodInvocation *context,
+                  const char *user_name,
+                  const char *group_name)
+{
+        GError *error;
+        gchar *argv[4];
+
+        argv[0] = (gchar*) "/usr/sbin/adduser";
+        argv[1] = (gchar*) user_name;
+        argv[2] = (gchar*) group_name;
+        argv[3] = NULL;
+
+        error = NULL;
+        if (!spawn_with_login_uid (context, argv, &error)) {
+                g_warning ("failed to add user %s to group %s", user_name, group_name);
+                g_error_free (error);
+                return;
+        }
+}
+
+void
+remove_user_from_group (GDBusMethodInvocation *context,
+                        const char *user_name,
+                        const char *group_name)
+{
+        GError *error;
+        gchar *argv[4];
+
+        argv[0] = (gchar*) "/usr/sbin/deluser";
+        argv[1] = (gchar*) user_name;
+        argv[2] = (gchar*) group_name;
+        argv[3] = NULL;
+
+        error = NULL;
+        if (!spawn_with_login_uid (context, argv, &error)) {
+                g_warning ("failed to remove user %s from group %s", user_name, group_name);
+                g_error_free (error);
+                return;
+        }
+}
diff --git a/src/util.h b/src/util.h
index 41ba545..bf7daf0 100644
--- a/src/util.h
+++ b/src/util.h
@@ -40,6 +40,14 @@ gint get_user_groups (const gchar  *username,
                       gid_t         group,
                       gid_t       **groups);
 
+void add_user_to_group (GDBusMethodInvocation *context,
+                        const char *user_name,
+                        const char *group_name);
+
+void remove_user_from_group (GDBusMethodInvocation *context,
+                             const char *user_name,
+                             const char *group_name);
+
 G_END_DECLS
 
 #endif /* __UTIL_H__ */
